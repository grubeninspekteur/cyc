---
## Java itself

- name: Installs Java7 + unzip
  apt: pkg={{ item }} state=installed update_cache={{ apt_update_cache }}
  with_items:
  - default-jre-headless
  - unzip

## binary&logs under /usr/local/cyc-engine-container

- name: copy engine-container.jar to tmp (ignore_change)
  copy: src=cyc-engine-container/engine-container-jar-with-dependencies.jar dest=/tmp
  changed_when: False

- name: check for changed engine-container
  shell: if [ "$(unzip -p /tmp/engine-container-jar-with-dependencies.jar -x META-INF/* | shasum)" = "$(unzip -p /usr/local/cyc-engine-container/engine-container-jar-with-dependencies.jar -x META-INF/* | shasum)" ] ; then exit 0 ; else exit 1 ; fi
  register: check_new_container
  changed_when: check_new_container.rc != 0
  ignore_errors: True
  failed_when: False 

- name: copy engine-container
  copy: src=cyc-engine-container dest=/usr/local/
  register: copied_container
  when: check_new_container.rc != 0

- name: create logs
  command: mkdir -p /usr/local/cyc-engine-container/logs creates=/usr/local/cyc-engine-container/logs

## config under /etc

- name: copy start/stop script
  copy: src=scripts/cyc-engine-container dest=/etc/init.d/cyc-engine-container mode=0755

- name: create security.policy for a config under /etc/cyc.properties
  copy: src=cyc-engine-container/security.policy dest=/etc/cyc-security.policy
  when: copied_container.changed
  notify:
    - restart cyc-engine-container

- name: add permission to read the config file
  lineinfile: dest=/etc/cyc-security.policy line='grant { permission java.io.FilePermission "/etc/cyc.properties", "read"; };'
  notify:
    - restart cyc-engine-container

- name: add socket permission (listen)
  lineinfile: dest=/etc/cyc-security.policy regexp='permission java.net.SocketPermission "localhost",.*resolve' line='permission java.net.SocketPermission "localhost", "resolve,listen";'
  notify:
    - restart cyc-engine-container

- name: add socket permission (from WEB)
  lineinfile: dest=/etc/cyc-security.policy regexp='permission java.net.SocketPermission ".*:-", "accept,resolve";' line='permission java.net.SocketPermission "{{ web_host }}:-", "accept,resolve";'
  notify:
    - restart cyc-engine-container

- name: add socket permission (to DB)
  lineinfile: dest=/etc/cyc-security.policy regexp='permission java.net.SocketPermission ".*:5984", "connect,resolve";' line='permission java.net.SocketPermission "{{ couchdb_host }}:5984", "connect,resolve";'
  notify:
    - restart cyc-engine-container

- name: auto start
  service: name=cyc-engine-container enabled=yes
